# 手机位移远程操控方案（gs_remote_control → gs_editor）

## 1. 目标

实现手机端采集“相对位移”（米），通过局域网 WebSocket 发送到 `gs_editor`，并在编辑器中：

1. 实时显示位移数值；
2. 将位移映射为相机平移，实现远程视角平移控制。

## 2. 架构

- 手机端（Android, `gs_remote_control`）
  - 传感器采集：
    - `TYPE_ACCELEROMETER`（加速度计）
    - `TYPE_GAME_ROTATION_VECTOR`（陀螺/姿态融合）
  - 将设备系加速度旋转到世界系，并积分得到速度 / 位移
  - 加入“短时间窗口小位移忽略”抑制静止漂移
  - 通过 WebSocket 服务端（`:8766`）广播 JSON

- PC 端（Web, `gs_editor`）
  - WebSocket 客户端连接手机 `ws://<phone_ip>:8766`
  - 消费消息 `relative_displacement`
  - 差分得到每帧位移增量，映射为相机世界坐标平移
  - 屏幕右上角显示连接状态、增量与累计位移

## 3. 通信协议

### 3.1 手机 → PC

```json
{
  "type": "relative_displacement",
  "dx": 0.012345,
  "dy": -0.000321,
  "dz": 0.004210,
  "vx": 0.101,
  "vy": -0.002,
  "vz": 0.031,
  "speed": 0.106,
  "origin": 2,
  "ts": 1760000000000
}
```

说明：

- `dx/dy/dz`：自最近一次重置以来累计位移（米）
- `origin`：重置序列号。重置后递增，PC 端据此清空差分基线
- `ts`：时间戳（毫秒）

### 3.2 PC → 手机

```json
{ "type": "reset" }
```

手机收到后重置速度与位移。

## 4. 已落地的关键改动

### 4.1 Android 端

- 使用 IMU（加速度计+陀螺）计算相对位移
- 新增“连接数”“位移显示”“重置按钮”
- WebSocket 约 20Hz 广播
- 支持来自 PC 的 `reset` 控制消息

### 4.2 gs_editor 端

- 新增 `src/remote-control.ts`：
  - 连接配置（IP/端口/缩放）
  - 状态面板与位移显示
  - 消费位移消息并下发 `camera.remoteTranslate`
- 新增 `camera.moveByWorldDelta()`：按世界坐标直接平移自由相机
- 在 `editor.ts` 注册远程平移事件并触发重渲染
- 在 `main.ts` 注册远程控制模块

## 5. 运行步骤

1. 手机与 PC 连接同一局域网。
2. Android Studio 打开 `gs_remote_control`，运行到手机。
3. 手机 App 点击 `Start`（启动 IMU + WS）。
4. PC 启动 `gs_editor`，在右上角 `Remote Control` 面板输入手机 IP 与端口（默认 8766），点击“连接”。
5. 移动手机，观察 `Δ` 与“累计”位移变化，同时场景相机平移。
6. 需要清零时：
   - 在 PC 端点“重置位移”（会下发 reset），或
   - 手机端点 `Reset Displacement`。

## 6. IMU 模式说明与漂移抑制

- 当前实现为“纯 IMU 相对位移”
  - 通过姿态矩阵将设备坐标加速度转到世界坐标
  - 对世界坐标下加速度积分得到速度和位移
- 漂移抑制策略：
  - 设置短时间窗口（约 0.4s）
  - 若窗口内累计位移很小（阈值约 8mm），则判定静止
  - 静止时清零速度并忽略该窗口位移累计，抑制“原地慢漂”
- 建议：
  - 连接后先保持静止 1~2 秒再移动
  - 若仍偏敏感，可适度增大静止位移阈值或缩短窗口

## 7. 验收标准（建议）

- [ ] 10 秒内平移响应实时（端到端延迟 < 100ms）
- [ ] 手机静止 5 秒时，视角基本无明显漂移
- [ ] 重置命令双端一致（`origin` 同步）
- [ ] 断连重连后自动恢复控制，不出现大跳变
